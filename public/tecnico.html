<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Soporte TÃ©cnico</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="css/chat.css">  
  <link rel="shortcut icon" href="img/toji.jpg" type="image/x-icon">
</head>
<body>
  <div class="chat-app">
    <aside class="sidebar">
        <h2>Solicitudes de Soporte</h2>
        <ul class="chat-list" id="lista-salas">
        <!-- AquÃ­ se agregan dinÃ¡micamente las salas -->
        </ul>
    </aside>

    <section class="chat-container">
        <header class="chat-header">
        <div class="chat-info">
            <h3 id="sala-actual">Selecciona una sala</h3>
        </div>
        </header>

        <main class="chat-messages" id="messages">
        <!-- AquÃ­ van los mensajes -->
        </main>

        <form id="formulario" class="chat-input">
        <input
            type="text"
            id="input"
            placeholder="Escribe tu mensaje..."
            required
            autocomplete="off"
        />
        <button type="submit">
            <i class="fa fa-paper-plane"></i>
        </button>
        </form>
    </section>
    </div>

  <script>
    const socket = io({ withCredentials: true });

    let salaActual = null;

    socket.on('connect', () => {
    console.log('ðŸ”Œ Conectado como tÃ©cnico');
    socket.emit('joinSupportRoom', 'tecnico');
    });

    socket.on('joinedPrivateRoom', data => {
    console.log('ðŸ‘¥ TÃ©cnico unido a salas:', data);
    });

    socket.on('notificacionSoporte', ({ room, username }) => {
    console.log('ðŸ“¢ Nuevo usuario solicitÃ³ soporte:', username);
    const li = document.createElement('li');
    li.classList.add('chat-category'); // para que tenga el estilo de lista
    li.textContent = username;
    li.dataset.room = room;
    li.style.cursor = 'pointer';
    li.onclick = () => {
        salaActual = room;
        document.getElementById('sala-actual').textContent = `Sala: ${username}`;
        document.getElementById('messages').innerHTML = '';
        socket.emit('joinSupportRoom', 'tecnico');
    };
    document.getElementById('lista-salas').appendChild(li);
    });

    socket.on('roomMessages', msgs => {
    msgs.forEach(msg => mostrarMensaje(msg));
    });

    socket.on('message', msg => {
    if (msg.room === salaActual) mostrarMensaje(msg);
    });

    function mostrarMensaje({ sender, message, timestamp }) {
    const div = document.createElement('div');
    div.classList.add('message');

    // Crear avatar del remitente, si tienes url usa sender.avatar o usa placeholder
    const avatar = document.createElement('img');
    avatar.classList.add('msg-avatar');
    avatar.src = sender.avatar || 'https://via.placeholder.com/36'; // placeholder
    avatar.alt = sender.username;

    // Contenido del mensaje
    const content = document.createElement('div');
    content.classList.add('msg-content');

    // Header con nombre y hora
    const header = document.createElement('div');
    header.classList.add('msg-header');
    header.innerHTML = `<strong>${sender.username}</strong> <span class="msg-time">${new Date(timestamp).toLocaleTimeString()}</span>`;

    // Texto del mensaje
    const p = document.createElement('p');
    p.textContent = message;

    content.appendChild(header);
    content.appendChild(p);

    div.appendChild(avatar);
    div.appendChild(content);

    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    document.getElementById('formulario').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('input');
    if (!salaActual) return alert('Selecciona una sala');
    socket.emit('chatMessage', { room: salaActual, message: input.value });
    input.value = '';
    });
  </script>
</body>
</html>